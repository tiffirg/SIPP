# Sipp

В этом репозитории находится реализация алгоритма планирования траектории в среде с динамическими препятствиями [Sipp](http://www.cs.cmu.edu/~maxim/files/sipp_icra11.pdf) с его модификациями [WSipp и FocalSipp](https://ojs.aaai.org/index.php/ICAPS/article/download/6674/6528). Реализация протестирована на выборке тестов с рандомно сгенерированными динамическими препятствиями. Результаты тестирования доступны в репозитории в [ноутбуке](Tests/analysis.ipynb).
Примеры заданий лежат [здесь](Examples/).

https://user-images.githubusercontent.com/56095630/171612138-c3e8d3a5-c2e6-4df3-bc4f-5a80a6fa414f.mp4

## Содержание

* [Examples](#examples)
* [Постановка задачи](#постановка-задачи)
* [Алгоритм Sipp](#алгоритм-sipp)
* [Визулизация](#визулизация)
* [Тестирование](#тестирование)
* [Ссылки](#ссылки)

## Examples
Директория содержит 4 папки:
- data - задания. Подробнее о том, в каком виде должно быть представлено задание, написано [ниже](#входные-данные).
- logs - решения этих заданий алгоритмами
- outputs - визуаулизация решений алгоритмов
- src - исходный код алгоритмов

## Постановка задачи
Пусть есть некоторая динамическая среда – двумерная карта со свободными и занятыми клетками, где занятые клетки – статические препятствия, при этом на карте также есть динамические препятствия. Динамические препятствия двигаются равномерно и прямолинейно между клетками с общей стороной, причем из любой клетки они могут переходить только в 4 направлениях: вверх, вниз, вправо, влево. Переход между клетками занимает 1 единицу времени. При целом числе единиц времени любое динамическое препятствие должно находиться в центре какой-нибудь клетки.

![directions](/Images/directions.png)

Есть агент, для которого нужно найти путь из данной клетки S (start) в данную клетку F (finish). Агент двигается равномерно и прямолинейно только по свободным клеткам, и так же, как и динамические препятствия, может переходить между клетками с общей стороной только в тех же 4 направлениях. Аналогично динамическим препятствиям, агент перемещается в соседнюю клетку за 1 единицу времени, и при целом числе времени должен находиться в центре какой-нибудь клетки.

**Задача**: для агента нужно найти путь из клетки S в клетку F, проходящий только по свободным клеткам, так что в любой момент времени координаты агента не совпадают ни с каким динамическим или статическим препятствием.
![grid](/Images/grid.png)

На рисунке пример поля на старте, белые клетки – свободные, черные – занятые. Красная точка – наш агент, стоит на старте. Клетка, помеченная буквой F, – финиш, куда нужно прийти агенту. 3 синие точки – динамические препятствия на своих стартовых позициях.

## Алгоритм Sipp

### Входные данные
Примеры заданий можно найти [здесь](/Examples/tasks). Теперь подробнее о значении тегов:
- \<map\> – тег открывает секцию, описывающую карту
- \<height\> и \<width\>  – высота и ширина карты соответственно.
- \<startx\>, \<starty\> – координаты старта агента, для которого будет строиться путь
- \<finishx\>, \<finishy\> – координаты финиша агента
- \<grid\> – описание свободных и занятых статическими препятствиями клеток карты.
- \<row\>  – одна строчка карты, значение клетки может быть равным 1, если в клетке статическое препятствие, или 0, если клетка свободна
- \<dynamicobstacles\> - описание траекторий движения динамических препятствий
- \<obstacle\> – внутри этого тега описание пути препятствия, таких тегов может быть несколько в теге \<dynamicobstacles\>

Траектория пути представляется в виде последовательности троек из целых неотрицательных чисел (x, y, time) – координаты клетки и время, в которое препятствие или агент там находится. Эта тройка записывается в XML файле как атрибуты тега \<point\>. Любые 2 соседние тройки должны образовывать либо прямолинейный отрезок пути так, что время движения между этими координатами должно быть в точности равно разнице координат времени в этих тройках, либо координаты клетки в соседних тройках должны быть равны, а координаты времени отличаются на целое число больше 0.

#### Пример представления пути
![path_representation](/Images/path_representation.png)

Пусть на рисунке траектория движения препятствия (или агента), начинающаяся в клетке (3, 2), конец – в клетке (0, 0). Пусть также в клетке (2, 1), он ждал 2 единицы времени. Тогда будет записано так:
```xml
<obstacle id="1">
    <point x="3" y="2" time="0"/>
    <point x="3" y="1" time="1"/>
    <point x="2" y="1" time="3"/>
    <point x="2" y="1" time="5"/>
    <point x="0" y="1" time="7"/>
    <point x="0" y="0" time="8"/>
 </obstacle>
```

## Визулизация
### Пререквизиты
Даны минимальные версии:
Python 3.10
BeautifulSoup4 4.10.0
ffmpeg 1.4
Matplotlib 3.5.1
NumPy 1.22.2

### Запуск
```bash
Python3 ../Src/Visualization/visualize.py log_file.xml [-o output_file.mp4]
```
log_file.xml - файл, полученный работой Sipp. Опционально, можно передать путь, куда будет записнао видео. По умолчанию, оно появляется в той же директории, что и log_file.xml

Примеры визуализаций можно найти [здесь](/Examples/videos/)
На всех видео синими точками обозначены динамические препятствия, красной - агент, для которого ищется путь. Белые клетки - свободные, черные - занятые.

https://user-images.githubusercontent.com/56095630/171612138-c3e8d3a5-c2e6-4df3-bc4f-5a80a6fa414f.mp4

## Тестирование и его результаты
Были сгенерированы тесты на картах размеров 256x256, 512x512 и 1024x1024 (по 30 карт каждого размера), для каждой из карт было сгенерировано задание с 10, 20, 50, 100, 200, 500, 1000 динамических препятствий (по 5 тестов для каждой конфигурации). Итого получилось 3150 тестов.
Sipp запускался на этих 3150 тестах, а Anytime Sipp на каждом из этих тестов по 3 раза: с разными начальными весами эвристики (2, 5, 10).
Результаты тестирования оформлены в качестве таблиц и графиков в [ноутбуке](Tests/analysis.ipynb).

## Ссылки
1. [SIPP: Safe interval path planning for dynamic environments](http://www.cs.cmu.edu/~maxim/files/sipp_icra11.pdf)
2. [Revisiting bounded-suboptimal safe interval path planning](https://ojs.aaai.org/index.php/ICAPS/article/download/6674/6528)
